<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Crop & Upload (F43GM)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px auto; max-width: 400px;width:calc(100vw - 20px) }
    input[type="text"], input[type="file"] { width:300px; margin: 6px 0; padding: 6px; border:1px solid #ccc ; border-radius:5px}
    button { padding: 10px 15px; background: #0078D7; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 8px; }
    button:disabled { background: #999; cursor: not-allowed; }
    .section {margin-top: 15px; border-radius: 8px; }
    img { max-width: 95%; margin-top: 8px; display: none; box-shadow:2px 2px 15px #ccc}
    #status { margin-top: 15px; font-size: 14px; }
    #resetBtn { display: none; background: #e81123; }
  </style>
</head>
<body>
 <h2>E) Sterilization Setting Control</h2>

  <label>Travel Form number (required):</label>
  <input id="filenameInput" type="text" placeholder="PLDC082025/0003" />

  <div class="section">
   <h4>Image A :Sticker Location</h4>
    <input type="file" id="fileInputA" accept="image/*" />
    <img id="previewA" />
    <button id="cropBtnA" style="display:none;">Crop Image A</button>
  </div>

  <div class="section">
    <h4>Image B :Product Loading Pattern</h4>
    <input type="file" id="fileInputB" accept="image/*" />
    <img id="previewB" />
    <button id="cropBtnB" style="display:none;">Crop Image B</button>
  </div>

  <button id="uploadBtn" disabled>Upload / Submit</button>
  <button id="resetBtn">Reset Form</button>
  <div id="status"></div>

  <script>
    const filenameInput = document.getElementById("filenameInput");
    const fileInputA = document.getElementById("fileInputA");
    const fileInputB = document.getElementById("fileInputB");
    const previewA = document.getElementById("previewA");
    const previewB = document.getElementById("previewB");
    const cropBtnA = document.getElementById("cropBtnA");
    const cropBtnB = document.getElementById("cropBtnB");
    const uploadBtn = document.getElementById("uploadBtn");
    const resetBtn = document.getElementById("resetBtn");
    const statusDiv = document.getElementById("status");

    let cropperA, cropperB;
    let imageA = null, imageB = null;
    let croppedA = false, croppedB = false;

    function checkReady() {
      uploadBtn.disabled = !(filenameInput.value.trim() && imageA && imageB);
    }

    function resetCropper(which) {
      const fileInput = which === "A" ? fileInputA : fileInputB;
      const preview = which === "A" ? previewA : previewB;
      const cropBtn = which === "A" ? cropBtnA : cropBtnB;
      if (which === "A" && cropperA) cropperA.destroy();
      if (which === "B" && cropperB) cropperB.destroy();
      preview.style.display = "none";
      cropBtn.style.display = "none";
      if (which === "A") { imageA = null; croppedA = false; }
      else { imageB = null; croppedB = false; }
      checkReady();
    }

    function setupCropper(inputElem, previewElem, cropBtn, which) {
      inputElem.addEventListener("change", e => {
        resetCropper(which);
        const file = e.target.files[0];
        if (!file) return;
        const url = URL.createObjectURL(file);
        previewElem.src = url;
        previewElem.style.display = "block";
        cropBtn.style.display = "inline-block";
        const cropper = new Cropper(previewElem, { aspectRatio: 1, viewMode: 1 });
        if (which === "A") cropperA = cropper;
        else cropperB = cropper;
        cropBtn.textContent = `Crop Image ${which}`;
      });

      cropBtn.addEventListener("click", () => {
        const cropper = which === "A" ? cropperA : cropperB;
        let croppedFlag = which === "A" ? croppedA : croppedB;
        if (!cropper) return;

        if (!croppedFlag) {
          const canvas = cropper.getCroppedCanvas({ width: 512, height: 512 });
          const base64 = canvas.toDataURL("image/jpeg");
          if (which === "A") { imageA = base64; croppedA = true; cropperA.destroy(); }
          else { imageB = base64; croppedB = true; cropperB.destroy(); }
          previewElem.src = base64;
          statusDiv.textContent = `Image ${which} cropped.`;
          cropBtn.textContent = `Re-Crop Image ${which}`;
        } else {
          const cropperNew = new Cropper(previewElem, { aspectRatio: 1, viewMode: 1 });
          if (which === "A") cropperA = cropperNew; else cropperB = cropperNew;
          if (which === "A") croppedA = false; else croppedB = false;
          statusDiv.textContent = `Re-cropping Image ${which}...`;
          cropBtn.textContent = `Crop Image ${which}`;
        }

        checkReady();
      });
    }

    setupCropper(fileInputA, previewA, cropBtnA, "A");
    setupCropper(fileInputB, previewB, cropBtnB, "B");
    filenameInput.addEventListener("input", checkReady);

    resetBtn.addEventListener("click", () => location.reload());

    uploadBtn.addEventListener("click", async () => {
      const filename = filenameInput.value.trim();
      if (!filename || !imageA || !imageB) {
        statusDiv.textContent = "Please provide filename and both cropped images.";
        return;
      }

      const payload = { filename, imageA, imageB };

      try {
        statusDiv.textContent = "Uploading...";
        const response = await fetch(
          "https://default4375f5a74f5e452692ef6789f385f0.3d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/ce293b7ee3cf4f218c834517989da8ca/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=eisCbBHPuJnWRnrobzxgg8Gjm5pX3a5OkVh3cgzDe_0",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          }
        );
        if (response.ok) {
          statusDiv.textContent = "Upload successful!";
          uploadBtn.disabled = true;
          resetBtn.style.display = "inline-block";
        } else {
          statusDiv.textContent = "Upload failed: " + response.status;
        }
      } catch (err) {
        statusDiv.textContent = "Error: " + err.message;
      }
    });
  </script>
</body>
</html>


