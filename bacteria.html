<!DOCTYPE html>
<html>
<head>

  <title>Lims:Bacteria </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.js"></script>
  <style> :root {
    --vh: 1vh; /* fallback */
  }
html  {
    height: calc(var(--vh) * 100);}
    .hero {
    width: 100%;
    height: 27px;
    vertical-align: text-top;
    text-align: left;
    font-weight: bold;
    border-radius: 1px;
    justify-content: center;
    color: #003479;
    text-shadow:1px 1px 8px #fff;
position:sticky; top:0; z-index:10;
    font-size: 27px;
 padding-left:8px;padding-bottom:2px;
   border-bottom:2px solid #22579ccc;
}


   body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial; margin-top: 0px ;margin-left:10px ;margin-right:5px ; margin-bottom:10px; max-width:calc(100vw - 15px)  ;width:320px;font-size:10px ;background:#f5f5f5;}
    input[type="text"], input[type="file"] { width:200px; margin: 6px 0; padding: 6px; border:1px solid #ccc ; border-radius:5px}
    input[type="number"]  { width:100px; padding: 6px; border:1px solid #ccc ; border-radius:5px}
    button { padding: 10px 15px; background: #0078D7; color: white; border: none; border-radius: 6px; cursor: pointer;  }
    button:disabled { background: #999; cursor: not-allowed; }
    .section {margin-top: 15px; border-radius: 8px; }
    img { max-width: 95%; margin-top: 8px; display: none; box-shadow:2px 2px 15px #ccc}
    #status { margin-top: 15px; font-size: 14px; }
    #resetBtn { display: none; background: #e81123; }
    select{width:80px}
    h2 { text-align:center; margin:10px 0; }
    .filter-box {
        padding:12px; background:white; display:flex; flex-direction:column; gap:10px;
         box-shadow:0 1px 5px rgba(0,0,0,0.08);
    }
    select , input[type="date"] { font-size:12px; padding:8px 6px; border-radius:8px; border:1px solid #ccc;}

    #cards { margin-top:10px;display:flex; flex-direction:column; gap:10px; }

    .card {
        padding:12px; border-radius:12px; box-shadow:0 3px 8px rgba(0,0,0,0.08);
        background:white;width:calc(100% - 15px)
    }

    .dispo-bar { height:6px; border-radius:6px; margin-bottom:8px; }
    .bar-blank { background:#ffee00; }
    .bar-pass  { background:#3afa00; }
    .bar-fail  { background:#f80202; }

    .row1,.row2,.row3 { font-size:10px; margin-bottom:3px; color:#111; }
    .clock { font-size:25px; font-weight:800; color:#111; display:inline-block; margin:6px;width:170px; }

    .btn-up {
        width:90px; margin:6px; padding:0px; font-size:16px;height:33px;text-align:right;
        border-radius:5px; border:none; color:#3c97ffdc; background:white; font-weight:700;
    }
  #btnLoad{font-size:22px ;padding:2px 10px}
    @media (min-width:300px){
        .card{max-width:300px;margin:0 auto;}
        .filter-box{max-width:420px;margin:0 auto;}
    }
   #cover {padding:5px ;background-color: #fff;box-shadow:0 3px 8px rgba(0,0,0,0.08);border-radius:3px;margin-top:10px}
</style>
</head>
<body>


<div class="hero">  <img src="TGLOGO.png" style="display:inline-block;height:25px;margin:0px">  LIMS  </div>


 <h3>Bacteria Test Result Recording</h3>

<div class="filter-box">


    <table>

<tr> <td>  <label>Factory:</label> </td>
<td>   <label>Date:</label></td>
<td>   <label>Load:</label></td></tr>
<tr> <td> <select id="factory">
        <option value="">?</option>
            <option value="M2">
            M2        </option>
            <option value="F3">
            F3        </option>
            <option value="F4">
            F4        </option>
            <option value="F7">
            F7        </option>
            <option value="F8A">
            F8A        </option>
            <option value="M9">
            M9        </option>
            <option value="F10">
            F10        </option>
            <option value="F12">
            F12        </option>
            <option value="F13" >
            F13        </option>
            <option value="F14">
            F14        </option>
            <option value="F18B">
            F18B        </option>
            <option value="F18G">
            F18G        </option>
            <option value="F19">
            F19        </option>
            <option value="F20">
            F20        </option>
            <option value="F21">
            F21        </option>
            <option value="F22">
            F22        </option>
            <option value="F24">
            F24        </option>
            <option value="F25">
            F25        </option>
            <option value="M26">
            M26        </option>
            <option value="F27">
            F27        </option>
            <option value="F29">
            F29        </option>
            <option value="F30">
            F30        </option>
            <option value="F31">
            F31        </option>
            <option value="F32">
            F32        </option>
            <option value="F33">
            F33        </option>
            <option value="F36">
            F36        </option>
            <option value="F38">
            F38        </option>
            <option value="F40">
            F40        </option>
            <option value="F41">
            F41        </option>
            <option value="F35A">
            F35A        </option>
    </select>
</td>
<td><input type="date" id="fdate"></td>
<td>    <button id="btnLoad">‚ü≥</button></td>

    </table>

  
   
 
    



    <label style="font-size:15px; display:flex; gap:8px; align-items:center;">
        <input type="checkbox" id="chkPending" checked>
        Pending Only
    </label>
</div>

<div id="cards" aria-live="polite">


    
</div>

<script>

    document.addEventListener("DOMContentLoaded", function () {
    const params = new URLSearchParams(window.location.search);

    const fac = params.get("Fac");   // Example: F13
    const date = params.get("date"); // Example: 08122025 (ddmmyyyy)

    const factorySelect = document.getElementById("factory");
    const dateInput = document.getElementById("fdate");

    let shouldCallLoad = false;

    // ----- FACTORY -----
    if (fac) {
        factorySelect.value = fac;
        shouldCallLoad = true; // only call when Fac exists
    }

    // ----- DATE -----
    let finalDate = "";

    if (date) {
        // Convert ddmmyyyy ‚Üí yyyy-mm-dd
        const dd = date.substring(0, 2);
        const mm = date.substring(2, 4);
        const yyyy = date.substring(4, 8);
        finalDate = `${yyyy}-${mm}-${dd}`;
    } else {
        // Always set today's date, even if no params
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, "0");
        const dd = String(today.getDate()).padStart(2, "0");
        finalDate = `${yyyy}-${mm}-${dd}`;
    }

    dateInput.value = finalDate;

    // ----- AUTO CALL -----
    if (shouldCallLoad) {
        loadRecords();
    }
});


/* ----------- CONFIG -------------- */
const GS_URL = "https://script.google.com/macros/s/AKfycbz0QJYvOJwCCTc47a6_Ou_zwIUg-y5WTyAAVFuS28Hq5idSBIntcDgs4S_Kr8P7U_1x/exec";

/* ----------- UTILITIES -------------- */
const safe = (v, d="") => (v === null || v === undefined ? d : v);
function formatLocal(d){ try{ return new Date(d).toLocaleString(); } catch(e){ return d; } }

/* Set today default */
document.getElementById("fdate").value = new Date().toISOString().slice(0,10);

/* Preselect factory from URL: ?Fac=F13 */
const urlParams = new URLSearchParams(window.location.search);
const paramFac = urlParams.get("Fac");
if (paramFac) {
    const sel = document.getElementById("factory");
    sel.value = paramFac;
}

/* Timers for clocks */
let timers = [];

/* Load event */
document.getElementById("btnLoad").addEventListener("click", loadRecords);
document.getElementById("chkPending").addEventListener("change", applyPendingFilter);

/* ----------- API WRAPPER -------------- */
function api(cmd, data, cb) {
    const fd = new FormData();
    fd.append("cmd", cmd);
    fd.append("data", JSON.stringify(data));

    fetch(GS_URL, { method: "POST", body: fd })
        .then(r => r.text())
        .then(t => JSON.parse(t))
        .then(cb)
        .catch(err => alert("API error: " + err));
}

/* ----------- LOAD RECORDS -------------- */
let lastRecords = [];

function loadRecords() {
    // Stop existing timers
    timers.forEach(id => clearInterval(id));
    timers = [];

    const fac = document.getElementById("factory").value;
    const date = document.getElementById("fdate").value;

    if (!fac || !date) {
        alert("Select Factory & Date");
        return;
    }

    api("loadRecords", { factory: fac, date: date, withDilution: 3, user: "" }, rec => {

        // Ensure array
        lastRecords = Array.isArray(rec) ? rec : [];

        // If empty ‚Üí handleEmpty()
        if (lastRecords.length === 0) {
            handleEmpty();
            return;
        }

        // Otherwise render normally
        renderCards();
        applyPendingFilter();
    });
}
function handleEmpty() {
    const container = document.getElementById("cards");
    container.innerHTML = `
        <div class="emptyBox">
            <p>No records found for this Factory & Date.</p>
        </div>
    `;
}

/* ----------- RENDER CARDS -------------- */
function renderCards() {
    const container = document.getElementById("cards");
    container.innerHTML = "";

    lastRecords.forEach((r, idx) => {
        const refId = safe(r[0], "");
        const line = safe(r[5], "-");
        const source = safe(r[3], "-");
        const sampleName = safe(r[4], "-");
        const sampling = safe(r[2], null);
        const samplePhoto = safe(r[13], "");
        const sampleResult = safe(r[14], "");
        const waterResult = safe(r[17], "");
        const sampleDispo = safe(r[15], "");
        const dilute = safe(r[11], true);
        const spec = safe(r[18], 1000 );

        const card = document.createElement("div");
        card.className = "card";

        card.dataset.dispo = sampleDispo; // store for pending filter

        const bar = document.createElement("div");
        bar.className = "dispo-bar " +
            (sampleDispo === "PASS" ? "bar-pass" :
             sampleDispo === "FAIL" ? "bar-fail" : "bar-blank");
        card.appendChild(bar);

        const row1 = document.createElement("div");
        row1.className = "row1";
        row1.textContent = `Line ${line} | ${source} | ${sampleName}`;
        card.appendChild(row1);

        const row2 = document.createElement("div");
        row2.className = "row2";

        const sampText = sampling ? formatLocal(sampling) : "No sampling time";
        row2.innerHTML = `Sampling Date & Time: ${sampText}`;




        card.appendChild(row2);


        const clock = document.createElement("div");
        clock.className = "clock";
        clock.textContent = "00:00:00";
        card.appendChild(clock);

        const newbutton = refId + " ‚ñ∂Ô∏è"
        const updatebutton =  refId + " üîÑ"
        const btn = document.createElement("button");
        btn.className = "btn-up";
        btn.textContent = samplePhoto ? updatebutton : newbutton ;
        btn.onclick = () => { selectId(refId,idx,dilute,spec)
            //const ref = refId || idx;
            //window.open("example.html?ref=" + encodeURIComponent(ref), "_blank");
        };
        card.appendChild(btn);


        if (sampling) {
            startClock(clock, new Date(sampling));
        }

        const row3 = document.createElement("div");
        row3.className = "row3";
        row3.textContent =
            `Result : ${sampleResult ?? "-"} | ${waterResult ?? "-"} | Disposition : ${sampleDispo || "-"}`;
        card.appendChild(row3);


        //card.appendChild(btn);

        container.appendChild(card);
    });
}

/* ----------- CLOCK -------------- */
function startClock(el, startDate) {
    const MAX_SEC = 51 * 3600; // 51 hours in seconds

    function tick() {
        const now = new Date();
        let diff = Math.floor((now - startDate) / 1000);

        // Exceeded 51 hours ‚Üí stop clock
        if (diff >= MAX_SEC) {
            el.textContent = "‚èπ --:--:--";
            return true; // signal to stop timer
        }

        if (diff < 0) diff = 0;
        const hh = String(Math.floor(diff / 3600)).padStart(2,'0');
        const mm = String(Math.floor((diff % 3600) / 60)).padStart(2,'0');
        const ss = String(diff % 60).padStart(2,'0');

        el.textContent = `‚è± ${hh}:${mm}:${ss}`;
        return false;
    }

    // First display
    if (tick()) return;

    const timerId = setInterval(() => {
        if (tick()) {
            clearInterval(timerId);  // stop ticking
        }
    }, 1000);

    timers.push(timerId);
}

/* ----------- PENDING FILTER -------------- */
function applyPendingFilter() {
    const pendingOnly = document.getElementById("chkPending").checked;
    const cards = document.querySelectorAll("#cards .card");

    cards.forEach(card => {
        const dispo = card.dataset.dispo || "";
        if (pendingOnly) {
            card.style.display = (dispo === "" ? "block" : "none");
        } else {
            card.style.display = "block";
        }
    });
}



function unselect(){
    const divform = document.getElementById("cover");
    const divdilute = document.getElementById("dilutecover");
     divform.style.display = "none"
     divdilute.style.display = "block" ;

applyPendingFilter()


}



function selectId(refId, idx ,dilute ,spec) {
    // Put refId into the input field
    const input = document.getElementById("filenameInput");
    if (!input) {
        console.error("filenameInput not found");
        return;
    }
    input.value = refId; // essential: updates UI state
    const inputspec = document.getElementById("spec");
    inputspec.value = spec
    // Select and toggle card visibility
    const cardsContainer = document.getElementById("cards");
    if (!cardsContainer) {
        console.error("cards container not found");
        return;
    }
    const divform = document.getElementById("cover");
    const divdilute = document.getElementById("dilutecover");
    const cancelBtn = document.getElementById("cancelBtn");
    divform.style.display = "block"
    divdilute.style.display = (dilute ? "block" : "none")
    cancelBtn.style.display = "inline-block"
    
    const cards = cardsContainer.querySelectorAll(".card");
    cards.forEach((card, i) => {
        // "why" comment: ensures only one card remains visible
        card.style.display = i === idx ? "block" : "none";
    });
}
</script>

<div id="cover" style="display:none" >

<label>Update Ref ID:</label><input id="filenameInput" type="number" placeholder="Ref ID" readonly>






<label id="filenameMsg" style="font-size:13px;display:block;margin-top:4px;"></label>

  <div class="section">
   <label>Image A : Sample Result photo</label>
    <input type="file" id="fileInputA" accept="image/*" />
    <img id="previewA" />
    <button id="cropBtnA" style="display:none;">Crop Image A</button>
  </div>

    <div class="section">
    <label>Result A: Sample Result value</label><br>
    <input type="number" id="resultA" onchange="autodispo()"/>
    
  </div>


<div id="dilutecover" style="display:none" >

  <div class="section">
    <label>Image B : Sample Test for Boiled/Sterile Water photo</label>
    <input type="file" id="fileInputB" accept="image/*" />
    <img id="previewB" />
    <button id="cropBtnB" style="display:none;">Crop Image B</button>
  </div>

  <div class="section">
    <label>Result B : Sample Result  for Boiled/Sterile Water value</label><br>
    <input type="number" id="resultB" />
    
  </div>
</div>

   <div class="section">

    <table>
<tr><th>Specification / Maximum :</th> <th> Disposition: </th></tr>
<tr><td> <input type="number" id="spec" readonly/></td>
<td> <select id="dispo" readonly>
      <option value="NA"></option>
      <option value="PASS">PASS</option>
      <option value="FAIL">FAIL</option>
    </select></td></tr>

    </table>

   

  </div>
<hr>
  <button id="uploadBtn" disabled>Upload / Submit</button>
  <button id="resetBtn">Reset Form</button> <button  id="cancelBtn" onclick="unselect()">Cancel</button>
  <div id="status"></div>
</div>

<script>



  const fileInputA = document.getElementById("fileInputA");
  const fileInputB = document.getElementById("fileInputB");
  const previewA = document.getElementById("previewA");
  const previewB = document.getElementById("previewB");
  const cropBtnA = document.getElementById("cropBtnA");
  const cropBtnB = document.getElementById("cropBtnB");

  const resultAInput = document.getElementById("resultA");
  const resultBInput = document.getElementById("resultB");

  const dispoSelect = document.getElementById("dispo");

  const uploadBtn = document.getElementById("uploadBtn");
  const resetBtn = document.getElementById("resetBtn");
  const cancelBtn = document.getElementById("cancelBtn");
  const statusDiv = document.getElementById("status");

  let cropperA, cropperB;
  let imageA = null, imageB = null;
  let croppedA = false, croppedB = false;
  //--auto dispo --

function autodispo() {
    const resultEl = document.getElementById("resultA");
    const specEl = document.getElementById("spec");
    const dispoEl = document.getElementById("dispo");

    if (!resultEl || !specEl || !dispoEl) return; // element missing

    const resultVal = parseFloat(resultEl.value);
    const specVal = parseFloat(specEl.value);

    // If invalid numbers ‚Üí cannot auto evaluate
    if (isNaN(resultVal) || isNaN(specVal)) {
        dispoEl.value = "NA";
        return;
    }

    // PASS / FAIL logic
    if (resultVal <= specVal) {
        dispoEl.value = "PASS";
    } else {
        dispoEl.value = "FAIL";
    }
}

  // ------------------- UPDATED -------------------
  function checkReady() {
    const hasFilename = filenameInput.value.trim() !== "";
    const hasImageA = !!imageA;
    const hasResultA = resultAInput.value.trim() !== "";  // required
    const hasDispo = dispoSelect.value.trim() !== "";

    uploadBtn.disabled = !(hasFilename && hasImageA && hasResultA && hasDispo);
  }
  // ------------------------------------------------

  function resetCropper(which) {
    const preview = which === "A" ? previewA : previewB;
    const cropBtn = which === "A" ? cropBtnA : cropBtnB;

    if (which === "A" && cropperA) cropperA.destroy();
    if (which === "B" && cropperB) cropperB.destroy();

    preview.style.display = "none";
    cropBtn.style.display = "none";

    if (which === "A") { imageA = null; croppedA = false; }
    else { imageB = null; croppedB = false; }

    checkReady();
  }

  function setupCropper(inputElem, previewElem, cropBtn, which) {
    inputElem.addEventListener("change", e => {
      resetCropper(which);
      const file = e.target.files[0];
      if (!file) return;

      const url = URL.createObjectURL(file);
      previewElem.src = url;
      previewElem.style.display = "block";
      cropBtn.style.display = "inline-block";

      const cropper = new Cropper(previewElem, { aspectRatio: 1, viewMode: 1 });
      if (which === "A") cropperA = cropper;
      else cropperB = cropper;

      cropBtn.textContent = `Crop Image ${which}`;
    });

    cropBtn.addEventListener("click", () => {
      const cropper = which === "A" ? cropperA : cropperB;
      let croppedFlag = which === "A" ? croppedA : croppedB;
      if (!cropper) return;

      if (!croppedFlag) {
        const canvas = cropper.getCroppedCanvas({ width: 512, height: 512 });
        const base64 = canvas.toDataURL("image/jpeg");

        if (which === "A") { imageA = base64; croppedA = true; cropperA.destroy(); }
        else { imageB = base64; croppedB = true; cropperB.destroy(); }

        previewElem.src = base64;
        statusDiv.textContent = `Image ${which} cropped.`;
        cropBtn.textContent = `Re-Crop Image ${which}`;
      } else {
        const cropperNew = new Cropper(previewElem, { aspectRatio: 1, viewMode: 1 });
        if (which === "A") cropperA = cropperNew;
        else cropperB = cropperNew;

        if (which === "A") croppedA = false;
        else croppedB = false;

        statusDiv.textContent = `Re-cropping Image ${which}...`;
        cropBtn.textContent = `Crop Image ${which}`;
      }

      checkReady();
    });
  }

  setupCropper(fileInputA, previewA, cropBtnA, "A");
  setupCropper(fileInputB, previewB, cropBtnB, "B");

  filenameInput.addEventListener("input", checkReady);
  resultAInput.addEventListener("input", checkReady);
  dispoSelect.addEventListener("change", checkReady);

  resetBtn.addEventListener("click", () => location.reload());

  // ------------------- UPDATED UPLOAD LOGIC -------------------
  uploadBtn.addEventListener("click", async () => {
    const filename = filenameInput.value.trim();
    const resultA = resultAInput.value.trim();
    const resultB = resultBInput.value.trim(); // optional
    const dispo = dispoSelect.value.trim();

    if (!filename || !imageA || !resultA || !dispo) {
      statusDiv.textContent = "Missing required fields.";
      return;
    }

    const payload = {
      filename,
      dispo,
      resultA,
      imageA
    };

    if (resultB !== "") payload.resultB = resultB; // include only if filled
    if (imageB) payload.imageB = imageB;           // include only if cropped

    try {
      statusDiv.textContent = "Uploading...";
 const response = await fetch("https://script.google.com/macros/s/AKfycbx4Ssu5VAAslCHWd_8QLPayH28uzd8se3lLjVsG1LrwaiW-zY0q_kG0_OfBdyRqiQnadQ/exec", {
        method: "POST",
        body: JSON.stringify(payload),
      });

      if (response.ok) {
        statusDiv.textContent = "Upload successful!";
        uploadBtn.disabled = true;
        resetBtn.style.display = "inline-block";
        cancelBtn.style.display = "none";
      } else {
        statusDiv.textContent = "Upload failed: " + response.status;
      }
    } catch (err) {
      statusDiv.textContent = "Error: " + err.message;
    }
  }); 

function updateVH() {
  const vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
}

updateVH();

// Update on resize/orientation change
window.addEventListener('resize', updateVH);</script>
</body>
</html>









