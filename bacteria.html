<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lims:Bacteria Upload </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.js"></script>
  <style>
   body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial; margin: 20px auto; max-width:calc(100vw - 50px)  ;width:300px;font-size:10px}
    input[type="text"], input[type="file"] { width:200px; margin: 6px 0; padding: 6px; border:1px solid #ccc ; border-radius:5px}
    select , input[type="number"]  { width:100px; padding: 6px; border:1px solid #ccc ; border-radius:5px}
    button { padding: 10px 15px; background: #0078D7; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 8px; }
    button:disabled { background: #999; cursor: not-allowed; }
    .section {margin-top: 15px; border-radius: 8px; }
    img { max-width: 95%; margin-top: 8px; display: none; box-shadow:2px 2px 15px #ccc}
    #status { margin-top: 15px; font-size: 14px; }
    #resetBtn { display: none; background: #e81123; }
 
  </style>



</head>
<body>
 <img src="limshead.png" style="display:inline-block;height:50px"> 
 <h3>Bacteria Test Result Recording</h3>

  <label>Ref ID:</label>
  <input id="filenameInput" type="text" placeholder="Ref ID" /><br>
    <label>TAC Nu.:</label>
    <input id="tac" type="text" placeholder="TAC" onchange="validate()" /><br>


<div id="msg"></div>

<script>
  // Convert number â†’ 6-digit uppercase hex
  function toHex6(num) {
    return (num >>> 0)
      .toString(16)
      .toUpperCase()
      .padStart(6, "0");
  }


  function calculate(n) {
  const coreValue = (n * 861107595687) / 7077;
  const roundedValue = Math.round(coreValue);
  const roundedString = String(roundedValue);
  const result = roundedString.slice(-7);
  return result;
}

  function validate() {
    const msg = document.getElementById("msg");
    const num = parseInt(document.getElementById("filenameInput").value, 10);
    const key = document.getElementById("tac").value.trim().toUpperCase();
    const curtain = document.getElementById("cover");

    if (isNaN(num)) {
      msg.innerHTML = "Invalid number";
      return;
    }

    const output = calculate(num)

    const hex = toHex6(output);

    msg.innerHTML = (hex === key)
      ? "Good"
      : "TAC is wrong";
    curtain.style.display = (hex === key)
    ? "block"
    : "none";
  }
</script>

<div id="cover" style="display:none" >
<label id="filenameMsg" style="font-size:13px;display:block;margin-top:4px;"></label>

  <div class="section">
   <label>Image A : Sample Result photo</label>
    <input type="file" id="fileInputA" accept="image/*" />
    <img id="previewA" />
    <button id="cropBtnA" style="display:none;">Crop Image A</button>
  </div>

    <div class="section">
    <label>Result A: Sample Result value</label><br>
    <input type="number" id="resultA" />
    
  </div>




  <div class="section">
    <label>Image B : Sample Test for Boiled/Sterile Water photo</label>
    <input type="file" id="fileInputB" accept="image/*" />
    <img id="previewB" />
    <button id="cropBtnB" style="display:none;">Crop Image B</button>
  </div>

  <div class="section">
    <label>Result B : Sample Result  for Boiled/Sterile Water value</label><br>
    <input type="number" id="resultB" />
    
  </div>


   <div class="section">
    <h4>Disposition:</h4>
    <select id="dispo">
      <option value="NA"></option>
      <option value="PASS">PASS</option>
      <option value="FAIL">FAIL</option>
    </select>

  </div>

  <button id="uploadBtn" disabled>Upload / Submit</button>
  <button id="resetBtn">Reset Form</button>
  <div id="status"></div>
</div>

<script>
  const filenameInput = document.getElementById("filenameInput");

  const fileInputA = document.getElementById("fileInputA");
  const fileInputB = document.getElementById("fileInputB");
  const previewA = document.getElementById("previewA");
  const previewB = document.getElementById("previewB");
  const cropBtnA = document.getElementById("cropBtnA");
  const cropBtnB = document.getElementById("cropBtnB");

  const resultAInput = document.getElementById("resultA");
  const resultBInput = document.getElementById("resultB");

  const dispoSelect = document.getElementById("dispo");

  const uploadBtn = document.getElementById("uploadBtn");
  const resetBtn = document.getElementById("resetBtn");
  const statusDiv = document.getElementById("status");

  let cropperA, cropperB;
  let imageA = null, imageB = null;
  let croppedA = false, croppedB = false;

  // ------------------- UPDATED -------------------
  function checkReady() {
    const hasFilename = filenameInput.value.trim() !== "";
    const hasImageA = !!imageA;
    const hasResultA = resultAInput.value.trim() !== "";  // required
    const hasDispo = dispoSelect.value.trim() !== "";

    uploadBtn.disabled = !(hasFilename && hasImageA && hasResultA && hasDispo);
  }
  // ------------------------------------------------

  function resetCropper(which) {
    const preview = which === "A" ? previewA : previewB;
    const cropBtn = which === "A" ? cropBtnA : cropBtnB;

    if (which === "A" && cropperA) cropperA.destroy();
    if (which === "B" && cropperB) cropperB.destroy();

    preview.style.display = "none";
    cropBtn.style.display = "none";

    if (which === "A") { imageA = null; croppedA = false; }
    else { imageB = null; croppedB = false; }

    checkReady();
  }

  function setupCropper(inputElem, previewElem, cropBtn, which) {
    inputElem.addEventListener("change", e => {
      resetCropper(which);
      const file = e.target.files[0];
      if (!file) return;

      const url = URL.createObjectURL(file);
      previewElem.src = url;
      previewElem.style.display = "block";
      cropBtn.style.display = "inline-block";

      const cropper = new Cropper(previewElem, { aspectRatio: 1, viewMode: 1 });
      if (which === "A") cropperA = cropper;
      else cropperB = cropper;

      cropBtn.textContent = `Crop Image ${which}`;
    });

    cropBtn.addEventListener("click", () => {
      const cropper = which === "A" ? cropperA : cropperB;
      let croppedFlag = which === "A" ? croppedA : croppedB;
      if (!cropper) return;

      if (!croppedFlag) {
        const canvas = cropper.getCroppedCanvas({ width: 512, height: 512 });
        const base64 = canvas.toDataURL("image/jpeg");

        if (which === "A") { imageA = base64; croppedA = true; cropperA.destroy(); }
        else { imageB = base64; croppedB = true; cropperB.destroy(); }

        previewElem.src = base64;
        statusDiv.textContent = `Image ${which} cropped.`;
        cropBtn.textContent = `Re-Crop Image ${which}`;
      } else {
        const cropperNew = new Cropper(previewElem, { aspectRatio: 1, viewMode: 1 });
        if (which === "A") cropperA = cropperNew;
        else cropperB = cropperNew;

        if (which === "A") croppedA = false;
        else croppedB = false;

        statusDiv.textContent = `Re-cropping Image ${which}...`;
        cropBtn.textContent = `Crop Image ${which}`;
      }

      checkReady();
    });
  }

  setupCropper(fileInputA, previewA, cropBtnA, "A");
  setupCropper(fileInputB, previewB, cropBtnB, "B");

  filenameInput.addEventListener("input", checkReady);
  resultAInput.addEventListener("input", checkReady);
  dispoSelect.addEventListener("change", checkReady);

  resetBtn.addEventListener("click", () => location.reload());

  // ------------------- UPDATED UPLOAD LOGIC -------------------
  uploadBtn.addEventListener("click", async () => {
    const filename = filenameInput.value.trim();
    const resultA = resultAInput.value.trim();
    const resultB = resultBInput.value.trim(); // optional
    const dispo = dispoSelect.value.trim();

    if (!filename || !imageA || !resultA || !dispo) {
      statusDiv.textContent = "Missing required fields.";
      return;
    }

    const payload = {
      filename,
      dispo,
      resultA,
      imageA
    };

    if (resultB !== "") payload.resultB = resultB; // include only if filled
    if (imageB) payload.imageB = imageB;           // include only if cropped

    try {
      statusDiv.textContent = "Uploading...";
 const response = await fetch("https://script.google.com/macros/s/AKfycbzjvP0SVclcJcmu6uV9aqYd6gAlFX2NU4KgWSFrV0AwbfaVLjcShiVo-wl3vrU_gFLvFw/exec", {
        method: "POST",
        body: JSON.stringify(payload),
      });

      if (response.ok) {
        statusDiv.textContent = "Upload successful!";
        uploadBtn.disabled = true;
        resetBtn.style.display = "inline-block";
      } else {
        statusDiv.textContent = "Upload failed: " + response.status;
      }
    } catch (err) {
      statusDiv.textContent = "Error: " + err.message;
    }
  }); </script>


</body>
</html>











